<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Psic√≥logo ‚Äì HelpMe</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="/js/sesion_psicologo.js"></script>
  <link rel="icon" href="/image/1000054885.png">
  

  <style>
    body {
      margin: 0;
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(to bottom right, #fceff9, #e0f7fa);
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 250px;
      background-color: #f3e5f5;
      padding: 30px 20px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }
    .sidebar h2 { color: #6a1b9a; margin-bottom: 30px; font-size: 1.5em; }
    .sidebar a {
      display: block; margin: 15px 0; text-decoration: none;
      color: #4a148c; font-weight: 500; padding: 10px;
      border-radius: 8px; transition: background 0.3s ease; cursor: pointer;
    }
    .sidebar a:hover { background-color: #ce93d8; color: white; }
    .main-content { flex: 1; padding: 40px; overflow-y: auto; }
    .main-content h1 { color: #6a1b9a; margin-bottom: 20px; }
    .section {
      display: none; background: white; border-radius: 15px;
      padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .section.active { display: block; }

    /* CHAT */
    .chat-container { display: flex; flex-direction: column; height: 400px; border: 1px solid #ddd; border-radius: 12px; overflow: hidden; }
    #msgs { flex: 1; padding: 15px; overflow-y: auto; background: #fafafa; }
    .msg { margin: 8px 0; padding: 10px; border-radius: 10px; max-width: 70%; background: #e1bee7; color: #4a148c; }
    .msg.me { background: #c5e1a5; color: #33691e; margin-left: auto; text-align: right; }
    .meta { font-size: 0.8em; color: #777; margin-bottom: 5px; }
    .chat-input { display: flex; border-top: 1px solid #ddd; }
    .chat-input input { flex: 1; padding: 10px; border: none; outline: none; }
    .chat-input button { background: #6a1b9a; color: white; border: none; padding: 10px 15px; cursor: pointer; transition: 0.3s; }
    .chat-input button:hover { background: #4a148c; }

    /* MODALES */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.5);
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 25px; border-radius: 12px;
      width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal h3 { margin-top: 0; color: #6a1b9a; }
    .modal button {
      margin: 10px 5px 0 0; padding: 10px 15px;
      border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
    }
    .cancelar { background: #e57373; color: white; }
    .aplazar { background: #ffb74d; color: white; }
    .adelantar { background: #64b5f6; color: white; }
    .cerrar { background: #9e9e9e; color: white; }
    .guardar { background: #81c784; color: white; }
    .icono-casa {
  width: 20px;          
  height: 20px;
  color: #6a1b9a;        
  cursor: pointer;       
  transition: transform 0.2s ease, color 0.2s ease;
}

.icono-casa:hover {
  color: #ff22e5;        /* cambia de color al pasar el mouse */
  transform: scale(1.15); /* efecto de aumento */
}


  </style>
</head>

<body>
  <!-- ===== SIDEBAR ===== -->
  <div class="sidebar">
    <h2>üë©‚Äç‚öïÔ∏è Panel Psic√≥logo</h2>
    <a href="/index.html"><svg class="icono-casa" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
    <path d="M9 21H4C3.44772 21 3 20.5523 3 20V12.4142C3 12.149 3.10536 11.8946 3.29289 11.7071L11.2929 3.70711C11.6834 3.31658 12.3166 3.31658 12.7071 3.70711L20.7071 11.7071C20.8946 11.8946 21 12.149 21 12.4142V20C21 20.5523 20.5523 21 20 21H15M9 21H15M9 21V15C9 14.4477 9.44772 14 10 14H14C14.5523 14 15 14.4477 15 15V21" 
    stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
  </svg> INICIO</a>
    <a data-section="mensajes">üì® Mensajes</a>
    <a data-section="citas">üìÖ Citas</a>
    <a data-section="perfil">üë§ Perfil</a>
    <a data-section="configuracion">‚öôÔ∏è Configuraci√≥n</a>
  </div>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="main-content">
    <h1>Bienvenido, Dr./Dra.</h1>

    <!-- ===== CHAT ===== -->
    <div id="mensajes" class="section">
      <h2>üì® Chat con Pacientes</h2>
      <div class="chat-wrapper" style="display:flex;height:400px;border:1px solid #ddd;border-radius:12px;overflow:hidden;">
        <!-- Lista de contactos -->
        <div class="contacts" style="width:200px;background:#f3e5f5;overflow-y:auto;">
          <h3 style="margin:10px;color:#6a1b9a;">Pacientes</h3>
          <ul id="contactList" style="list-style:none;padding:0;margin:0;"></ul>
        </div>
        <!-- Ventana de chat -->
        <div class="chat-container" style="flex:1;display:flex;flex-direction:column;">
          <div id="chatHeader" style="background:#6a1b9a;color:white;padding:10px;">Selecciona un paciente</div>
          <div id="msgs"></div>
          <div class="chat-input">
            <input type="text" id="msgInput" placeholder="Escribe un mensaje...">
            <button onclick="sendMsg()">Enviar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== CITAS ===== -->
    <div id="citas" class="section active">
      <div id="calendar"></div>
    </div>

    <!-- ===== PERFIL ===== -->
      <div id="perfil" class="section">
      <h2>üë§ Perfil</h2>
       <div id="usuario-info" style="display:none; align-items:center; gap:10px; margin:20px;">
        Bienvenido, <span id="usuario-correo" style="font-weight:600;"></span>
        <button class="btn btn-primary" id="cerrar-sesion">
        <span class="btn-txt">Cerrar sesi√≥n</span>
        <kbd class="btn-kbd"><img src="/image/logout-svgrepo-com.svg" alt="cerrar" style="width:16px;"></kbd>
        </button>
</div>
    </div>

    <!-- ===== CONFIGURACI√ìN ===== -->
    <div id="configuracion" class="section">
      <h2>‚öôÔ∏è Configuraci√≥n</h2>
      <p>Ajustes de la cuenta, notificaciones, etc.</p>
    </div>
  </div>

  <!-- ===== MODALES ===== -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title"></h3>
      <p><strong>Paciente:</strong> <span id="modal-paciente"></span></p>
      <p><strong>Hora:</strong> <span id="modal-hora"></span></p>
      <p><strong>Notas:</strong> <span id="modal-notas"></span></p>
      <button class="cancelar">Cancelar</button>
      <button class="aplazar">Aplazar</button>
      <button class="adelantar">Adelantar</button>
      <button class="cerrar">Cerrar</button>
    </div>
  </div>

  <div id="modal-reprogramar" class="modal">
    <div class="modal-content">
      <h3 id="reprogramar-titulo">Reprogramar Cita</h3>
      <label>Nueva fecha y hora:</label><br>
      <input type="datetime-local" id="nueva-fecha-hora"><br><br>
      <button class="guardar">Guardar</button>
      <button class="cerrar">Cerrar</button>
    </div>
  </div>

  <!-- =============================== -->
  <!-- ======= SCRIPTS JS ============ -->
  <!-- =============================== -->
  <script>
  // ===== Navegaci√≥n Sidebar =====
  document.querySelectorAll(".sidebar a").forEach(link => {
    link.addEventListener("click", () => {
      const sectionId = link.getAttribute("data-section");
      document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(sectionId).classList.add("active");
    });
  });

  // ===== Chat con pacientes =====

let currentChat = null;
let currentPacienteId = null;
const currentUser = "Psic√≥logo";

async function cargarPacientes() {
  const psicologoId = localStorage.getItem("psicologo_id");

  if (!psicologoId) {
    alert("No se encontr√≥ el ID del psic√≥logo. Inicia sesi√≥n nuevamente.");
    window.location.href = "/html/psicologo.html";
    return;
  }

  try {
    const res = await fetch(`http://127.0.0.1:5000/chats?psicologo_id=${psicologoId}`);
    const data = await res.json();

    const list = document.getElementById('contactList');
    list.innerHTML = '';

    if (!Array.isArray(data) || data.length === 0) {
      list.innerHTML = '<li style="padding:10px;color:#777;">No tienes pacientes asignados</li>';
      return;
    }

    data.forEach(p => {
      const li = document.createElement('li');
      li.textContent = p.paciente_nombre;
      li.style.cssText = 'padding:10px;cursor:pointer;';
      li.onclick = () => openChat(p.paciente_nombre, p.paciente_id);
      list.appendChild(li);
    });
  } catch (err) {
    console.error('Error cargando pacientes:', err);
  }
}

async function openChat(nombre, id) {
  currentChat = nombre;
  currentPacienteId = id;
  document.getElementById("chatHeader").textContent = "Chat con " + nombre;
  document.getElementById("msgs").innerHTML = "";

  localStorage.setItem("ultimo_chat_paciente", id);
  localStorage.setItem("ultimo_chat_nombre", nombre);

  try {
    const psicologoId = localStorage.getItem("psicologo_id");

    const res = await fetch(`http://127.0.0.1:5000/obtener_mensajes/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ psicologo_id: psicologoId })
    });

    const data = await res.json();

    if (data.status === "ok" && Array.isArray(data.mensajes)) {
      data.mensajes.forEach(m => {
        const sender = m.remitente === 'psicologo' ? currentUser : currentChat;
        appendMessage({ sender, text: m.mensaje });
      });
    }
  } catch (err) {
    console.error('Error al cargar mensajes:', err);
  }
}

function appendMessage(message) {
  const wrap = document.createElement("div");
  const isMe = message.sender === currentUser;
  wrap.style.cssText = `
    margin:8px 0; padding:10px; border-radius:10px; max-width:70%;
    ${isMe ? "background:#c5e1a5; margin-left:auto; text-align:right;" : "background:#e1bee7;"}
  `;
  wrap.innerHTML = `<b>${message.sender}</b><br>${message.text}`;
  const msgBox = document.getElementById("msgs");
  msgBox.appendChild(wrap);
  msgBox.scrollTop = msgBox.scrollHeight;
}

async function sendMsg() {
  if (!currentPacienteId) return alert("Selecciona un paciente primero");
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if (!text) return;

  appendMessage({ sender: currentUser, text });
  input.value = "";

  const psicologoId = localStorage.getItem("psicologo_id");

  try {
    const res = await fetch('http://127.0.0.1:5000/enviar_mensaje', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        psicologo_id: psicologoId,
        paciente_id: currentPacienteId,
        mensaje: text,
        remitente: 'psicologo'
      })
    });
    const data = await res.json();
    if (data.status !== 'ok') alert('Error: ' + data.message);
  } catch (err) {
    console.error('Error al enviar mensaje:', err);
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  await cargarPacientes();
  const lastChatId = localStorage.getItem("ultimo_chat_paciente");
  const lastChatName = localStorage.getItem("ultimo_chat_nombre");
  if (lastChatId && lastChatName) {
    openChat(lastChatName, lastChatId);
  }
});


  // ===== FullCalendar =====
 document.addEventListener('DOMContentLoaded', function() {
  let calendarEl = document.getElementById('calendar');
  let selectedEvent = null;

  // ID del psic√≥logo logueado (c√°mbialo din√°micamente seg√∫n tu sesi√≥n)
  const psicologo_id = sessionStorage.getItem("psicologo_id") || 1;

  let calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'es',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },

    // üî• Cargar eventos desde Flask
    events: `http://127.0.0.1:5000/obtener_reservas/${psicologo_id}`,

    eventClick(info) {
      selectedEvent = info.event;
      document.getElementById('modal-title').textContent = info.event.title;
      document.getElementById('modal-paciente').textContent = info.event.extendedProps.paciente;
      document.getElementById('modal-hora').textContent = new Date(info.event.start).toLocaleString();
      document.getElementById('modal-notas').textContent = info.event.extendedProps.notas;
      document.getElementById('modal').style.display = 'flex';
    }
  });

  calendar.render();

  // === Modales ===
  document.querySelector('#modal .cerrar').onclick = () => document.getElementById('modal').style.display = 'none';
  document.querySelector('#modal .cancelar').onclick = () => {
    if (selectedEvent) selectedEvent.remove();
    alert("Cita cancelada");
    document.getElementById('modal').style.display = 'none';
  };
  document.querySelector('#modal .aplazar').onclick = () => {
    document.getElementById('modal').style.display = 'none';
    document.getElementById('reprogramar-titulo').textContent = "Aplazar Cita";
    document.getElementById('modal-reprogramar').style.display = 'flex';
  };
  document.querySelector('#modal .adelantar').onclick = () => {
    document.getElementById('modal').style.display = 'none';
    document.getElementById('reprogramar-titulo').textContent = "Adelantar Cita";
    document.getElementById('modal-reprogramar').style.display = 'flex';
  };

  document.querySelector('#modal-reprogramar .cerrar').onclick = () => document.getElementById('modal-reprogramar').style.display = 'none';
  document.querySelector('#modal-reprogramar .guardar').onclick = () => {
    let nuevaFecha = document.getElementById('nueva-fecha-hora').value;
    if (selectedEvent && nuevaFecha) {
      let start = new Date(nuevaFecha);
      selectedEvent.setStart(start);
      alert("Cita reprogramada para: " + start.toLocaleString());
    }
    document.getElementById('modal-reprogramar').style.display = 'none';
  };
});
  </script>
</body>
</html>
